<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Habit Tracker</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4F46E5">
  <meta name="description" content="Personal habit tracking app">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Habits">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { margin: 0; padding: 0; overflow-x: hidden; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const CheckCircle = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
    const Circle = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2} /></svg>;
    const Calendar = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth={2}/><line x1="16" y1="2" x2="16" y2="6" strokeWidth={2}/><line x1="8" y1="2" x2="8" y2="6" strokeWidth={2}/><line x1="3" y1="10" x2="21" y2="10" strokeWidth={2}/></svg>;
    const TrendingUp = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" strokeWidth={2}/><polyline points="17 6 23 6 23 12" strokeWidth={2}/></svg>;
    const Download = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
    const ChevronLeft = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>;
    const ChevronRight = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>;
    const Play = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" strokeWidth={2}/></svg>;
    const Pause = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16" strokeWidth={2}/><rect x="14" y="4" width="4" height="16" strokeWidth={2}/></svg>;
    const Square = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" strokeWidth={2}/></svg>;

    function HabitTracker() {
      const [trackedData, setTrackedData] = useState(() => {
        try {
          const saved = localStorage.getItem('habitTrackerData');
          return saved ? JSON.parse(saved) : {};
        } catch (e) {
          return {};
        }
      });
      
      const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
      const [currentStartTimes, setCurrentStartTimes] = useState({});
      const [currentEndTimes, setCurrentEndTimes] = useState({});
      const [currentNotes, setCurrentNotes] = useState({});
      const [dailyNote, setDailyNote] = useState('');
      const [currentTimeBlock, setCurrentTimeBlock] = useState(0);
      const [timers, setTimers] = useState({});
      const [timerStartTimes, setTimerStartTimes] = useState({});
      const [elapsedSeconds, setElapsedSeconds] = useState({});

      const habits = [
        { id: 1, name: '10' },
        { id: 5, name: 'Meditate' },
        { id: 4, name: 'Objective-led deep work (incl. progression)' },
        { id: 3, name: '1000' },
        { id: 2, name: '100' }
      ];

      useEffect(() => {
        try {
          localStorage.setItem('habitTrackerData', JSON.stringify(trackedData));
        } catch (e) {
          console.error('Failed to save data:', e);
        }
      }, [trackedData]);

      useEffect(() => {
        const updateTimeBlock = () => {
          const now = new Date();
          const minutesSinceMidnight = now.getHours() * 60 + now.getMinutes();
          const block = Math.floor(minutesSinceMidnight / 40);
          setCurrentTimeBlock(block);
        };
        updateTimeBlock();
        const interval = setInterval(updateTimeBlock, 60000);
        return () => clearInterval(interval);
      }, []);

      useEffect(() => {
        const interval = setInterval(() => {
          setElapsedSeconds(prev => {
            const updated = { ...prev };
            Object.keys(timers).forEach(habitId => {
              if (timers[habitId] && timerStartTimes[habitId]) {
                updated[habitId] = Math.floor((Date.now() - timerStartTimes[habitId]) / 1000);
              }
            });
            return updated;
          });
        }, 1000);
        return () => clearInterval(interval);
      }, [timers, timerStartTimes]);

      const getChristmasWeek = (year) => {
        const christmas = new Date(year, 11, 25);
        const dayOfWeek = christmas.getDay();
        const sunday = new Date(christmas);
        sunday.setDate(christmas.getDate() - dayOfWeek);
        const week = [];
        for (let i = 0; i < 7; i++) {
          const day = new Date(sunday);
          day.setDate(sunday.getDate() + i);
          week.push(day.toISOString().split('T')[0]);
        }
        return week;
      };

      const isWorkDay = (dateStr) => {
        const date = new Date(dateStr + 'T00:00:00');
        const dayOfWeek = date.getDay();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const year = date.getFullYear();

        if (trackedData[dateStr]?.flexDayOff) return false;
        if (dayOfWeek === 6) return false;
        if (month === 6 && day === 10) return false;
        if (month === 7 && day === 18) return false;
        if (month === 8 && day === 27) return false;
        if (month === 9 && day === 18) return false;

        const christmasWeek = getChristmasWeek(year);
        if (christmasWeek.includes(dateStr)) return false;

        return true;
      };

      const isNaturalWorkDay = (dateStr) => {
        const date = new Date(dateStr + 'T00:00:00');
        const dayOfWeek = date.getDay();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const year = date.getFullYear();

        if (dayOfWeek === 6) return false;
        if (month === 6 && day === 10) return false;
        if (month === 7 && day === 18) return false;
        if (month === 8 && day === 27) return false;
        if (month === 9 && day === 18) return false;

        const christmasWeek = getChristmasWeek(year);
        if (christmasWeek.includes(dateStr)) return false;

        return true;
      };

      const getDateData = (date) => trackedData[date] || {};

      const getSpecialDates = (dateStr) => {
        const date = new Date(dateStr + 'T00:00:00');
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const dates = [];

        const specialDays = {
          '01-09': "Shelagh's birthday",
          '01-17': "Jack's birthday",
          '01-18': "Peter's birthday",
          '02-28': "Alistair's birthday",
          '03-26': "Sebastian's birthday",
          '06-09': "Jin's birthday",
          '06-10': "Theo's birthday",
          '06-30': "Rowan's birthday",
          '07-14': "Arthy's birthday",
          '07-18': "Rachael's birthday",
          '08-06': "Ed's birthday",
          '08-27': "Wedding anniversary",
          '09-18': "Tristan's birthday",
          '09-26': "Andrew's birthday",
          '10-15': "Mum's birthday",
          '10-19': "Chloe's birthday",
          '11-03': "Dad's birthday",
          '11-07': "Rashad's birthday",
          '12-03': "Victoria's birthday",
          '12-12': "Ollie's birthday"
        };

        const key = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        if (specialDays[key]) {
          dates.push(specialDays[key]);
        }

        if (month === 1 && day === 1) dates.push("New Year's Day");
        if (month === 12 && day === 25) dates.push("Christmas Day");
        if (month === 12 && day === 26) dates.push("Boxing Day");

        return dates;
      };

      const isHabitComplete = (habitId, date) => {
        const dateData = getDateData(date);
        return dateData[`task${habitId}Complete`] || false;
      };

      const isDayComplete = (date) => {
        if (!isWorkDay(date)) return true;
        const dateData = getDateData(date);
        const allHabitsComplete = [1, 2, 3, 4, 5].every(id => isHabitComplete(id, date));
        const totalTime = [1, 2, 3, 4, 5].reduce((sum, id) => sum + (dateData[`time${id}`] || 0), 0);
        return allHabitsComplete && totalTime >= 360;
      };

      const getTotalTime = (date) => {
        const dateData = getDateData(date);
        return [1, 2, 3, 4, 5].reduce((sum, id) => sum + (dateData[`time${id}`] || 0), 0);
      };

      const getOvertimeBank = () => {
        let totalOvertime = 0;
        Object.keys(trackedData).forEach(date => {
          if (isWorkDay(date)) {
            const totalTime = getTotalTime(date);
            if (totalTime > 360) {
              totalOvertime += (totalTime - 360);
            }
          }
        });
        return totalOvertime;
      };

      const getFlexDaysRemaining = () => {
        const earned = Math.floor(getOvertimeBank() / 360);
        const used = Object.keys(trackedData).filter(d => trackedData[d]?.flexDayOff).length;
        return 10 + earned - used;
      };

      const getOvertimeProgress = () => {
        return getOvertimeBank() % 360;
      };

      const toggleFlexDayOff = () => {
        const isCurrentlyFlex = trackedData[selectedDate]?.flexDayOff;
        setTrackedData(prev => ({
          ...prev,
          [selectedDate]: {
            ...prev[selectedDate],
            flexDayOff: !isCurrentlyFlex
          }
        }));
      };

      const updateHabit = (habitId) => {
        setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`task${habitId}Complete`]: true}}));
      };

      const deleteTask = (habitId) => {
        setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`task${habitId}Complete`]: false}}));
      };

      const calculateMinutes = (startTime, endTime) => {
        if (!startTime || !endTime) return 0;
        const [startHour, startMin] = startTime.split(':').map(Number);
        const [endHour, endMin] = endTime.split(':').map(Number);
        const startMinutes = startHour * 60 + startMin;
        let endMinutes = endHour * 60 + endMin;
        if (endMinutes < startMinutes) endMinutes += 24 * 60;
        return endMinutes - startMinutes;
      };

      const updateTime = (habitId) => {
        const startTime = currentStartTimes[habitId];
        const endTime = currentEndTimes[habitId];
        if (startTime && endTime) {
          const minutes = calculateMinutes(startTime, endTime);
          if (minutes > 0) {
            const currentTotal = getDateData(selectedDate)[`time${habitId}`] || 0;
            setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`time${habitId}`]: currentTotal + minutes, [`timeEntries${habitId}`]: [...(prev[selectedDate]?.[`timeEntries${habitId}`] || []), { start: startTime, end: endTime, minutes }]}}));
            setCurrentStartTimes(prev => ({ ...prev, [habitId]: '' }));
            setCurrentEndTimes(prev => ({ ...prev, [habitId]: '' }));
          }
        }
      };

      const deleteTimeEntry = (habitId, entryIndex) => {
        const dateData = getDateData(selectedDate);
        const timeEntries = dateData[`timeEntries${habitId}`] || [];
        const entryToDelete = timeEntries[entryIndex];
        if (entryToDelete) {
          const newEntries = timeEntries.filter((_, index) => index !== entryIndex);
          const currentTotal = dateData[`time${habitId}`] || 0;
          const newTotal = Math.max(0, currentTotal - entryToDelete.minutes);
          setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`time${habitId}`]: newTotal, [`timeEntries${habitId}`]: newEntries}}));
        }
      };

      const startTimer = (habitId) => {
        setTimers(prev => ({ ...prev, [habitId]: true }));
        setTimerStartTimes(prev => ({ ...prev, [habitId]: Date.now() }));
        setElapsedSeconds(prev => ({ ...prev, [habitId]: 0 }));
      };

      const pauseTimer = (habitId) => {
        setTimers(prev => ({ ...prev, [habitId]: false }));
      };

      const stopTimer = (habitId) => {
        const elapsed = elapsedSeconds[habitId] || 0;
        
        if (elapsed > 0) {
          const minutes = Math.floor(elapsed / 60);
          const currentTotal = getDateData(selectedDate)[`time${habitId}`] || 0;
          const now = new Date();
          const endTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          const startDate = new Date(timerStartTimes[habitId]);
          const startTime = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
          setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`time${habitId}`]: currentTotal + minutes, [`timeEntries${habitId}`]: [...(prev[selectedDate]?.[`timeEntries${habitId}`] || []), { start: startTime, end: endTime, minutes }]}}));
        }
        
        setTimers(prev => ({ ...prev, [habitId]: false }));
        setTimerStartTimes(prev => ({ ...prev, [habitId]: null }));
        setElapsedSeconds(prev => ({ ...prev, [habitId]: 0 }));
      };

      const formatTime = (seconds) => {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const updateNote = (habitId) => {
        const note = currentNotes[habitId] || '';
        setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`note${habitId}`]: note}}));
        setCurrentNotes(prev => ({ ...prev, [habitId]: '' }));
      };

      const editNote = (habitId) => {
        const existingNote = getDateData(selectedDate)[`note${habitId}`] || '';
        setCurrentNotes(prev => ({ ...prev, [habitId]: existingNote }));
      };

      const deleteNote = (habitId) => {
        setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], [`note${habitId}`]: ''}}));
        setCurrentNotes(prev => ({ ...prev, [habitId]: '' }));
      };

      const updateDailyNote = () => {
        const userNote = dailyNote.trim();
        setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], dailyNote: userNote}}));
        setDailyNote('');
      };

      const editDailyNote = () => {
        const existingNote = getDateData(selectedDate).dailyNote || '';
        setDailyNote(existingNote);
      };

      const deleteDailyNote = () => {
        setTrackedData(prev => ({...prev, [selectedDate]: {...prev[selectedDate], dailyNote: ''}}));
        setDailyNote('');
      };

      const exportToExcel = () => {
        const dates = Object.keys(trackedData).sort();
        let csvContent = "Date,Work Day,Flex Day,Task 1,Task 1 Time,Task 1 Note,Task 5,Task 5 Time,Task 5 Note,Task 4,Task 4 Time,Task 4 Note,Task 3,Task 3 Time,Task 3 Note,Task 2,Task 2 Time,Task 2 Note,Total Time,Overtime,Daily Note,All Complete\n";
        dates.forEach(date => {
          const data = trackedData[date];
          const workDay = isWorkDay(date);
          const targetTime = workDay ? 360 : 0;
          const totalTime = (data.time1 || 0) + (data.time2 || 0) + (data.time3 || 0) + (data.time4 || 0) + (data.time5 || 0);
          const overtime = workDay && totalTime > 360 ? totalTime - 360 : 0;
          const row = [
            date,
            workDay ? 'Yes' : 'No',
            data.flexDayOff ? 'Yes' : 'No',
            data.task1Complete ? 'Yes' : 'No',
            data.time1 || 0,
            `"${(data.note1 || '').replace(/"/g, '""')}"`,
            data.task5Complete ? 'Yes' : 'No',
            data.time5 || 0,
            `"${(data.note5 || '').replace(/"/g, '""')}"`,
            data.task4Complete ? 'Yes' : 'No',
            data.time4 || 0,
            `"${(data.note4 || '').replace(/"/g, '""')}"`,
            data.task3Complete ? 'Yes' : 'No',
            data.time3 || 0,
            `"${(data.note3 || '').replace(/"/g, '""')}"`,
            data.task2Complete ? 'Yes' : 'No',
            data.time2 || 0,
            `"${(data.note2 || '').replace(/"/g, '""')}"`,
            totalTime,
            overtime,
            `"${(data.dailyNote || '').replace(/"/g, '""')}"`,
            (!workDay || (data.task1Complete && data.task5Complete && data.task4Complete && data.task3Complete && data.task2Complete && (totalTime >= targetTime))) ? 'Yes' : 'No'
          ];
          csvContent += row.join(',') + '\n';
        });

        csvContent += `\nFlex Days Remaining,${getFlexDaysRemaining()}\n`;
        csvContent += `Overtime Bank,${getOvertimeBank()} minutes\n`;

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `habit_tracker_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const getStreak = () => {
        let streak = 0;
        let checkDate = new Date();
        while (streak < 365) {
          const dateStr = checkDate.toISOString().split('T')[0];
          if (!isDayComplete(dateStr)) break;
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        }
        return streak;
      };

      const changeDate = (days) => {
        const date = new Date(selectedDate);
        date.setDate(date.getDate() + days);
        setSelectedDate(date.toISOString().split('T')[0]);
      };

      const goToToday = () => setSelectedDate(new Date().toISOString().split('T')[0]);

      const generateCalendarDays = () => {
        const days = [];
        
        // Get today's date in local time
        const now = new Date();
        const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        
        // Parse the selected date parts
        const [year, month, day] = selectedDate.split('-').map(Number);
        
        // Start 7 days before the selected date
        let currentDate = new Date(year, month - 1, day - 7);
        
        for (let i = 0; i < 16; i++) {
          const y = currentDate.getFullYear();
          const m = String(currentDate.getMonth() + 1).padStart(2, '0');
          const d = String(currentDate.getDate()).padStart(2, '0');
          const dateStr = `${y}-${m}-${d}`;
          
          days.push({
            date: dateStr,
            isComplete: isDayComplete(dateStr),
            isSelected: dateStr === selectedDate,
            isToday: dateStr === todayStr,
            display: currentDate.getDate()
          });
          currentDate.setDate(currentDate.getDate() + 1);
        }
        return days;
      };

      const completedToday = habits.filter(h => isHabitComplete(h.id, selectedDate)).length;
      const totalTime = getTotalTime(selectedDate);
      const targetTime = isWorkDay(selectedDate) ? 360 : 0;
      const timeComplete = totalTime >= targetTime;
      const calendarDays = generateCalendarDays();
      const isToday = selectedDate === new Date().toISOString().split('T')[0];
      const visibleHabits = isToday ? habits.filter(h => !isHabitComplete(h.id, selectedDate)) : habits;
      const isWorkDaySelected = isWorkDay(selectedDate);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-1">
          <div className="max-w-6xl mx-auto">
            <div className="flex gap-1">
              {isToday && (
                <div className="flex flex-col flex-shrink-0 self-stretch">
                  {Array.from({ length: 36 }).map((_, index) => {
                    const isPast = index < currentTimeBlock;
                    const isCurrent = index === currentTimeBlock;
                    const hours = Math.floor(index * 40 / 60);
                    const minutes = (index * 40) % 60;
                    const timeLabel = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    return (
                      <div
                        key={index}
                        className={`w-9 flex-1 rounded-sm ${isPast ? 'bg-red-500' : 'bg-green-500'} ${isCurrent ? 'ring-1 ring-blue-600' : ''} flex items-center justify-center text-white text-[8px] font-mono`}
                      >
                        {timeLabel}
                      </div>
                    );
                  })}
                </div>
              )}

              <div className="flex-1 min-w-0 bg-white rounded-lg shadow-lg p-1.5 flex flex-col">
                <div className="mb-1">
                  <div className="flex items-center justify-between mb-0.5">
                    <h1 className="text-sm font-bold text-gray-800">Habits</h1>
                    <button onClick={exportToExcel} className="p-1 bg-green-600 text-white rounded">
                      <Download className="w-3 h-3" />
                    </button>
                  </div>
                  <div className="flex items-center justify-between text-[9px]">
                    {!isWorkDaySelected && (
                      <div className="text-blue-600 font-semibold">Day Off</div>
                    )}
                    <div className="flex items-center gap-1 text-indigo-600">
                      <TrendingUp className="w-2.5 h-2.5" />
                      <span className="font-bold">{getStreak()}d</span>
                    </div>
                    <div className="flex items-center gap-1 text-purple-600">
                      <span className="font-bold">Flex: {getFlexDaysRemaining()}</span>
                    </div>
                  </div>
                  <div className="mt-0.5">
                    {isNaturalWorkDay(selectedDate) && !trackedData[selectedDate]?.flexDayOff && getFlexDaysRemaining() > 0 && (
                      <button 
                        onClick={toggleFlexDayOff}
                        className="w-full text-[9px] bg-purple-100 hover:bg-purple-200 rounded p-0.5"
                      >
                        Use Flex Day
                      </button>
                    )}
                    {trackedData[selectedDate]?.flexDayOff && (
                      <button 
                        onClick={toggleFlexDayOff}
                        className="w-full text-[9px] bg-orange-100 hover:bg-orange-200 rounded p-0.5"
                      >
                        Cancel Flex Day
                      </button>
                    )}
                  </div>
                </div>

                <div className="mb-1.5 overflow-x-auto">
                  <div className="flex gap-0.5 pb-0.5">
                    {calendarDays.map((day) => (
                      <div key={day.date} onClick={() => setSelectedDate(day.date)} className={`w-5 h-5 rounded cursor-pointer flex items-center justify-center text-[9px] font-medium ${day.isSelected ? 'ring-1 ring-indigo-600' : ''} ${day.isComplete ? 'bg-green-500 text-white' : 'bg-red-400 text-white'} ${day.isToday && !day.isSelected ? 'ring-1 ring-yellow-400' : ''}`}>
                        {day.display}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="mb-1.5 flex items-center justify-between bg-indigo-50 rounded p-0.5">
                  <button onClick={() => changeDate(-1)} className="p-0.5"><ChevronLeft className="w-3 h-3 text-indigo-600" /></button>
                  <div className="flex items-center gap-0.5">
                    <Calendar className="w-2.5 h-2.5" />
                    <span className="text-[9px] font-semibold">{new Date(selectedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                    {!isToday && (<button onClick={goToToday} className="px-1 py-0.5 bg-indigo-600 text-white text-[8px] rounded">Now</button>)}
                  </div>
                  <button onClick={() => changeDate(1)} className="p-0.5"><ChevronRight className="w-3 h-3 text-indigo-600" /></button>
                </div>

                {getSpecialDates(selectedDate).length > 0 && (
                  <div className="mb-1.5 bg-pink-50 border border-pink-200 rounded p-1">
                    {getSpecialDates(selectedDate).map((specialDate, idx) => (
                      <div key={idx} className="text-[9px] text-pink-800 font-medium">
                        {specialDate}
                      </div>
                    ))}
                  </div>
                )}

                {isWorkDaySelected && (
                  <div className="mb-1.5 bg-indigo-50 rounded p-1">
                    <div className="flex justify-between text-[9px] mb-0.5">
                      <span className={timeComplete ? 'text-green-600 font-bold' : ''}>{totalTime}/360</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-1 mb-1">
                      <div className="bg-indigo-600 h-1 rounded-full" style={{ width: `${Math.min((totalTime / 360) * 100, 100)}%` }}></div>
                    </div>
                    {totalTime > 360 && (
                      <div className="text-[8px] text-purple-600">
                        +{totalTime - 360} m overtime ({360 - getOvertimeProgress()} minutes to next flex day)
                      </div>
                    )}
                  </div>
                )}

                <div className="mb-1.5">
                  <div className="flex gap-0.5">
                    <input type="text" placeholder="Daily note..." value={dailyNote} onChange={(e) => setDailyNote(e.target.value)} className="flex-1 px-1 py-0.5 text-[9px] border rounded outline-none" />
                    <button onClick={updateDailyNote} className="px-1.5 py-0.5 rounded flex items-center justify-center" style={{ backgroundColor: 'rgb(242, 182, 4)' }}>
                      <div className="w-2 h-2 bg-white rounded-full"></div>
                    </button>
                  </div>
                  {getDateData(selectedDate).dailyNote && (
                    <div className="mt-0.5 bg-blue-50 rounded p-0.5">
                      <div className="flex items-start gap-0.5">
                        <div className="flex-1 text-[8px] italic">"{getDateData(selectedDate).dailyNote}"</div>
                        <button onClick={editDailyNote} className="px-1 py-0.5 bg-blue-600 text-white text-[7px] rounded">Edit</button>
                        <button onClick={deleteDailyNote} className="px-1 py-0.5 bg-red-600 text-white text-[7px] rounded">Del</button>
                      </div>
                    </div>
                  )}
                </div>

                {isWorkDaySelected ? (
                  <div className="space-y-1.5 flex-1">
                    {visibleHabits.map(habit => {
                      const complete = isHabitComplete(habit.id, selectedDate);
                      const dateData = getDateData(selectedDate);
                      const habitTime = dateData[`time${habit.id}`] || 0;
                      const habitNote = dateData[`note${habit.id}`] || '';
                      const isTimerRunning = timers[habit.id] || false;
                      const timerElapsed = elapsedSeconds[habit.id] || 0;

                      return (
                        <div key={habit.id} className="border rounded p-1">
                          <div className="flex items-start gap-1">
                            <div className="mt-0.5">{complete ? <CheckCircle className="w-3 h-3 text-green-500" /> : <Circle className="w-3 h-3 text-gray-300" />}</div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center justify-between mb-0.5">
                                <h3 className="text-[10px] font-semibold">{habit.name}</h3>
                              </div>
                              
                              <div className="mb-0.5">
                                {!complete ? (
                                  <button onClick={() => updateHabit(habit.id)} className="w-full px-1 py-0.5 bg-indigo-600 text-white text-[9px] rounded">Done</button>
                                ) : (
                                  <div className="flex gap-0.5">
                                    <div className="flex-1 px-1 py-0.5 bg-green-100 text-green-800 text-[9px] rounded text-center">Complete</div>
                                    <button onClick={() => deleteTask(habit.id)} className="px-1 py-0.5 bg-red-600 text-white text-[7px] rounded">Del</button>
                                  </div>
                                )}
                              </div>

                              <div className="bg-purple-50 rounded p-0.5 mb-0.5">
                                <div className="flex justify-between items-center mb-0.5">
                                  <span className="text-[9px] font-mono font-bold text-purple-700">{formatTime(timerElapsed)}</span>
                                </div>
                                <div className="flex gap-0.5">
                                  {!isTimerRunning ? (
                                    <button onClick={() => startTimer(habit.id)} className="flex-1 flex items-center justify-center px-0.5 py-0.5 bg-green-600 text-white rounded text-[8px]"><Play className="w-2 h-2" /></button>
                                  ) : (
                                    <button onClick={() => pauseTimer(habit.id)} className="flex-1 flex items-center justify-center px-0.5 py-0.5 bg-yellow-600 text-white rounded text-[8px]"><Pause className="w-2 h-2" /></button>
                                  )}
                                  <button onClick={() => stopTimer(habit.id)} disabled={timerElapsed === 0} className="flex-1 flex items-center justify-center px-0.5 py-0.5 bg-red-600 text-white rounded text-[8px] disabled:opacity-50"><Square className="w-2 h-2" /></button>
                                </div>
                              </div>

                              <div className="bg-gray-50 rounded p-0.5 mb-0.5">
                                <div className="text-[8px] mb-0.5">
                                  <span className="font-medium">{habitTime}m</span>
                                </div>
                                {!complete && (
                                  <div className="flex gap-0.5 mb-0.5">
                                    <input type="time" value={currentStartTimes[habit.id] || ''} onChange={(e) => setCurrentStartTimes(prev => ({ ...prev, [habit.id]: e.target.value }))} className="flex-1 px-0.5 py-0.5 text-[8px] border rounded outline-none" />
                                    <input type="time" value={currentEndTimes[habit.id] || ''} onChange={(e) => setCurrentEndTimes(prev => ({ ...prev, [habit.id]: e.target.value }))} className="flex-1 px-0.5 py-0.5 text-[8px] border rounded outline-none" />
                                    <button onClick={() => updateTime(habit.id)} className="px-1 py-0.5 bg-gray-600 text-white text-[8px] rounded">+</button>
                                  </div>
                                )}
                                {dateData[`timeEntries${habit.id}`] && dateData[`timeEntries${habit.id}`].length > 0 && (
                                  <div className="space-y-0.5">
                                    {dateData[`timeEntries${habit.id}`].map((entry, idx) => (
                                      <div key={idx} className="flex items-center justify-between text-[7px] bg-white rounded px-0.5 py-0.5">
                                        <span>{entry.start} - {entry.end} ({entry.minutes}m)</span>
                                        {!complete && (
                                          <button onClick={() => deleteTimeEntry(habit.id, idx)} className="px-1 py-0.5 bg-red-600 text-white rounded">x</button>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>

                              <div className="bg-amber-50 rounded p-0.5">
                                {habitNote && (
                                  <div className="mb-0.5 bg-white rounded p-0.5">
                                    <div className="flex items-start gap-0.5">
                                      <div className="flex-1 text-[8px] italic">"{habitNote}"</div>
                                      {!complete && (
                                        <div className="flex gap-0.5">
                                          <button onClick={() => editNote(habit.id)} className="px-1 py-0.5 bg-blue-600 text-white text-[7px] rounded">Edit</button>
                                          <button onClick={() => deleteNote(habit.id)} className="px-1 py-0.5 bg-red-600 text-white text-[7px] rounded">Del</button>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                )}
                                {!complete && (
                                  <div className="flex gap-0.5">
                                    <input type="text" placeholder="Note..." value={currentNotes[habit.id] || ''} onChange={(e) => setCurrentNotes(prev => ({ ...prev, [habit.id]: e.target.value }))} className="flex-1 px-0.5 py-0.5 text-[8px] border rounded outline-none" />
                                    <button onClick={() => updateNote(habit.id)} className="px-1.5 py-0.5 rounded flex items-center justify-center" style={{ backgroundColor: 'rgb(242, 182, 4)' }}>
                                      <div className="w-2 h-2 bg-white rounded-full"></div>
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="text-center py-4">
                    <div className="text-2xl">ðŸŽ‰</div>
                    <h3 className="text-xs font-semibold text-gray-600">Day Off</h3>
                  </div>
                )}

                {isWorkDaySelected && completedToday === 5 && timeComplete && (
                  <div className="mt-1.5 bg-green-50 border border-green-200 rounded p-1 text-center">
                    <div className="text-lg">ðŸŽ‰</div>
                    <h3 className="text-[9px] font-bold text-green-800">Done!</h3>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<HabitTracker />, document.getElementById('root'));
  </script>
</body>
</html>